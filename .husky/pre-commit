#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running linter on staged files..."
npx lint-staged

echo "ğŸ§ª Running tests..."
npm test

# Run Spectral linting on Postman collections if they changed
if git diff --cached --name-only | grep -qE "postman/collections/"; then
  echo "ğŸ“‹ Linting Postman collections with Spectral..."
  node .spectral/lint-with-names.js
  
  if [ $? -ne 0 ]; then
    echo "âŒ Spectral linting failed for Postman collections"
    exit 1
  fi
  
  echo "âœ… Postman collection linting passed!"
fi

# Run Postman tests only if Postman collection files changed
if git diff --cached --name-only | grep -qE "postman/"; then
  echo "ğŸ“¬ Postman collection changed - Running Postman tests..."
  
  # Run all collections in postman/collections/
  for collection in postman/collections/*.postman_collection.json; do
    if [ -f "$collection" ]; then
      echo "  â†’ Running: $(basename "$collection")"
      postman collection run "$collection"
      
      if [ $? -ne 0 ]; then
        echo "âŒ Postman collection failed: $collection"
        exit 1
      fi
    fi
  done
  
  echo "âœ… All Postman collections passed!"
else
  echo "â­ï¸  No Postman collection changes detected, skipping Postman tests"
fi

echo "âœ… All pre-commit checks passed!"
