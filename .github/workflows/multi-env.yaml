name: Multi-Environment Collection Runner

# Runs Postman collections against multiple environments in parallel.
# Useful for validating the same collection against dev and staging
# before merging changes that affect both.
#
# Prerequisites:
#   - One environment file per target in postman/environments/:
#       postman/environments/dev.postman_environment.json
#       postman/environments/staging.postman_environment.json
#   - POSTMAN_API_KEY stored in GitHub Actions secrets

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  run-collections:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false   # let all environments run even if one fails
      matrix:
        environment: [dev, staging]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Postman CLI
        run: curl -o- "https://dl-cli.pstmn.io/install/unix.sh" | sh

      - name: Authenticate with Postman
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: postman login --with-api-key "$POSTMAN_API_KEY"

      - name: Lint collections with Spectral
        run: npm run lint:collections

      # TEMPLATE: Start your API server pointed at the right environment
      # - name: Start API server (${{ matrix.environment }})
      #   env:
      #     NODE_ENV: ${{ matrix.environment }}
      #   run: |
      #     npm start &
      #     sleep 5

      - name: Run collections against ${{ matrix.environment }}
        run: |
          ENV_FILE="postman/environments/${{ matrix.environment }}.postman_environment.json"

          if [ ! -f "$ENV_FILE" ]; then
            echo "❌ Environment file not found: $ENV_FILE"
            exit 1
          fi

          for collection in postman/collections/*.postman_collection.json; do
            echo "▶️  Running $(basename "$collection") → ${{ matrix.environment }}"
            postman collection run "$collection" \
              --environment "$ENV_FILE" \
              --reporter cli
          done

  # Runs after all matrix jobs pass. Only publishes on merge to main.
  publish:
    runs-on: ubuntu-latest
    needs: run-collections
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Install Postman CLI
        run: curl -o- "https://dl-cli.pstmn.io/install/unix.sh" | sh

      - name: Authenticate with Postman
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: postman login --with-api-key "$POSTMAN_API_KEY"

      - name: Publish workspace to Postman Cloud
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: postman workspace push -y
