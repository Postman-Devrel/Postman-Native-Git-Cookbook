name: Security - Scan for Secrets

on:
  push:
    branches: [main, develop]
    paths:
      - 'postman/**'
  pull_request:
    branches: [main]
    paths:
      - 'postman/**'

jobs:
  secret-scan:
    name: Scan Collections for Exposed Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install -g @stoplight/spectral-cli

      - name: Scan for hardcoded credentials with Spectral
        id: spectral-scan
        run: |
          echo "üîç Scanning for exposed secrets in Postman collections..."

          # Run Spectral focusing on security rules
          spectral lint postman/collections/*.postman_collection.json \
            --fail-severity error \
            --format json > spectral-results.json || true

          # Parse results and check for security violations
          if grep -q '"code".*"no-hardcoded"' spectral-results.json; then
            echo "üîí SECURITY VIOLATIONS FOUND!"
            echo "has_violations=true" >> $GITHUB_OUTPUT
            cat spectral-results.json
            exit 1
          else
            echo "‚úÖ No exposed secrets found"
            echo "has_violations=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for common secret patterns
        run: |
          echo "üîç Checking for common secret patterns..."

          # Patterns to search for
          declare -a patterns=(
            "Bearer [A-Za-z0-9\-._~+/]+=*"
            "api[_-]?key[\"']?\s*[:=]\s*[\"'][^\"']{20,}[\"']"
            "password[\"']?\s*[:=]\s*[\"'][^\"']{8,}[\"']"
            "secret[\"']?\s*[:=]\s*[\"'][^\"']{20,}[\"']"
            "[0-9a-f]{32}"  # MD5 hashes that might be API keys
            "sk_live_[0-9a-zA-Z]{24,}"  # Stripe keys
            "ghp_[0-9a-zA-Z]{36}"  # GitHub personal access tokens
          )

          violations_found=false

          for pattern in "${patterns[@]}"; do
            if grep -rE "$pattern" postman/collections/ postman/environments/ 2>/dev/null; then
              echo "‚ùå Potential secret found matching pattern: $pattern"
              violations_found=true
            fi
          done

          if [ "$violations_found" = true ]; then
            echo "üîí Potential secrets detected! Please review the matches above."
            exit 1
          else
            echo "‚úÖ No common secret patterns found"
          fi

      - name: Check for localhost URLs
        run: |
          echo "üîç Checking for hardcoded localhost URLs..."

          if grep -r "http://localhost" postman/collections/ 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: Hardcoded localhost URLs found"
            echo "Consider using environment variables like {{baseUrl}}"
          else
            echo "‚úÖ No hardcoded localhost URLs"
          fi

      - name: Verify environment variable usage
        run: |
          echo "üîç Verifying proper use of environment variables..."

          # Check that auth headers use variables
          if grep -rE '"(Authorization|x-api-key)".*"value".*"[^{]' postman/collections/ | grep -v '{{' 2>/dev/null; then
            echo "‚ùå Found authentication headers not using variables!"
            echo "All auth headers should use {{variable}} syntax"
            exit 1
          else
            echo "‚úÖ Authentication headers properly use variables"
          fi

      - name: Block PR if secrets found
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîí **SECURITY ALERT: Potential Secrets Detected**

            The security scan found potential exposed secrets in your Postman collections.

            **What to do:**
            1. Review the scan results in the workflow logs
            2. Replace any hardcoded credentials with \`{{variables}}\`
            3. Use environment files for sensitive data
            4. Add environment files to \`.gitignore\`

            **Example - Correct Usage:**
            \`\`\`json
            {
              "header": [
                {
                  "key": "x-api-key",
                  "value": "{{apiKey}}",
                  "type": "text"
                }
              ]
            }
            \`\`\`

            ‚õî **This PR cannot be merged until security violations are resolved.**
            `
            });

            // Add label to PR
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security', 'blocked']
            });

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results
          path: |
            spectral-results.json
          retention-days: 30

      - name: Success message
        if: success()
        run: |
          echo "‚úÖ Security scan passed!"
          echo "No exposed secrets or credentials found in Postman collections."
